//@version=5
indicator("PDH/PDL Strategy - XAU/USD | London & NY Sessions", overlay=true, max_labels_count=500, max_lines_count=500)

// ═══════════════════════════════════════════════
//  INPUTS
// ═══════════════════════════════════════════════
session_filter = input.string("Both", "Session Filter", options=["London", "New York", "Both"])
breakout_mode  = input.bool(true, "Show Breakout Signals")
reversal_mode  = input.bool(true, "Show Reversal Signals")
atr_mult_tp1   = input.float(1.0, "TP1 ATR Multiplier", step=0.1)
atr_mult_tp2   = input.float(2.0, "TP2 ATR Multiplier", step=0.1)
atr_mult_sl    = input.float(0.8, "SL ATR Multiplier",  step=0.1)
show_pdhl      = input.bool(true, "Show PDH/PDL Lines")

// ═══════════════════════════════════════════════
//  SESSIONS  (UTC-5 / EST)
// ═══════════════════════════════════════════════
london_session = time(timeframe.period, "0300-1100:23456")
ny_session     = time(timeframe.period, "0800-1600:23456")

in_london  = not na(london_session)
in_ny      = not na(ny_session)
in_session = session_filter == "London" ? in_london : session_filter == "New York" ? in_ny : (in_london or in_ny)

// ═══════════════════════════════════════════════
//  PREVIOUS DAY HIGH / LOW
// ═══════════════════════════════════════════════
[pd_high, pd_low] = request.security(syminfo.tickerid, "D", [high[1], low[1]], lookahead=barmerge.lookahead_on)

var line pdh_line = na
var line pdl_line = na
is_new_day = ta.change(time("D")) != 0

if is_new_day and show_pdhl
    if not na(pdh_line)
        line.delete(pdh_line)
    if not na(pdl_line)
        line.delete(pdl_line)
    pdh_line := line.new(bar_index, pd_high, bar_index + 300, pd_high, color=color.new(color.orange, 0), width=2, style=line.style_dashed)
    pdl_line := line.new(bar_index, pd_low,  bar_index + 300, pd_low,  color=color.new(color.aqua,   0), width=2, style=line.style_dashed)

if not na(pdh_line)
    line.set_x2(pdh_line, bar_index + 55)
if not na(pdl_line)
    line.set_x2(pdl_line, bar_index + 55)

var label pdh_tag = na
var label pdl_tag = na
if barstate.islast
    if not na(pdh_tag)
        label.delete(pdh_tag)
    if not na(pdl_tag)
        label.delete(pdl_tag)
    pdh_tag := label.new(bar_index + 57, pd_high, "PDH  " + str.tostring(math.round(pd_high, 2)), color=color.orange, textcolor=color.black, style=label.style_label_left, size=size.small)
    pdl_tag := label.new(bar_index + 57, pd_low,  "PDL  " + str.tostring(math.round(pd_low,  2)), color=color.aqua,   textcolor=color.black, style=label.style_label_left, size=size.small)

// ═══════════════════════════════════════════════
//  ATR
// ═══════════════════════════════════════════════
atr = ta.atr(14)

// ═══════════════════════════════════════════════
//  SIGNAL DETECTION
// ═══════════════════════════════════════════════
bull_breakout = breakout_mode and in_session and ta.crossover(close, pd_high)
bear_breakout = breakout_mode and in_session and ta.crossunder(close, pd_low)

touched_pdh = high >= pd_high and close < pd_high
touched_pdl = low  <= pd_low  and close > pd_low

bear_reversal = reversal_mode and in_session and touched_pdh and (open - close) > (high - low) * 0.5
bull_reversal = reversal_mode and in_session and touched_pdl and (close - open) > (high - low) * 0.5

bull_signal = bull_breakout or bull_reversal
bear_signal = bear_breakout or bear_reversal

// ═══════════════════════════════════════════════
//  ACTIVE TRADE STATE
// ═══════════════════════════════════════════════
var float  active_entry   = na
var float  active_tp1     = na
var float  active_tp2     = na
var float  active_sl      = na
var bool   active_is_bull = true
var string active_kind    = ""
var string active_time    = ""
var bool   trade_active   = false

if bull_signal
    active_entry   := close
    active_tp1     := close + atr * atr_mult_tp1
    active_tp2     := close + atr * atr_mult_tp2
    active_sl      := close - atr * atr_mult_sl
    active_is_bull := true
    active_kind    := bull_breakout ? "BREAKOUT" : "REVERSAL"
    active_time    := str.format_time(time, "HH:mm", syminfo.timezone)
    trade_active   := true

if bear_signal
    active_entry   := close
    active_tp1     := close - atr * atr_mult_tp1
    active_tp2     := close - atr * atr_mult_tp2
    active_sl      := close + atr * atr_mult_sl
    active_is_bull := false
    active_kind    := bear_breakout ? "BREAKOUT" : "REVERSAL"
    active_time    := str.format_time(time, "HH:mm", syminfo.timezone)
    trade_active   := true

if trade_active and not na(active_sl) and not na(active_tp2)
    if active_is_bull
        if low <= active_sl or high >= active_tp2
            trade_active := false
    else
        if high >= active_sl or low <= active_tp2
            trade_active := false

if is_new_day
    trade_active := false

// ═══════════════════════════════════════════════
//  ACTIVE TRADE LINES
// ═══════════════════════════════════════════════
var line line_tp2   = na
var line line_tp1   = na
var line line_entry = na
var line line_sl    = na
var label lbl_tp2   = na
var label lbl_tp1   = na
var label lbl_entry = na
var label lbl_sl    = na

if bull_signal or bear_signal
    flag_txt   = (bull_signal ? "LONG  " : "SHORT  ") + active_kind
    flag_color = bull_signal ? color.lime : color.red
    flag_tc    = bull_signal ? color.black : color.white
    flag_style = bull_signal ? label.style_label_up : label.style_label_down
    flag_y     = bull_signal ? active_sl - atr * 0.5 : active_sl + atr * 0.5
    label.new(bar_index, flag_y, flag_txt, color=flag_color, textcolor=flag_tc, style=flag_style, size=size.large)

if trade_active and not na(active_entry)
    clr_tp2 = active_is_bull ? color.new(color.lime, 0) : color.new(color.red, 0)
    clr_tp1 = active_is_bull ? color.new(color.lime, 40) : color.new(color.red, 40)
    right   = bar_index + 60

    if not na(line_tp2)
        line.delete(line_tp2)
    if not na(line_tp1)
        line.delete(line_tp1)
    if not na(line_entry)
        line.delete(line_entry)
    if not na(line_sl)
        line.delete(line_sl)
    if not na(lbl_tp2)
        label.delete(lbl_tp2)
    if not na(lbl_tp1)
        label.delete(lbl_tp1)
    if not na(lbl_entry)
        label.delete(lbl_entry)
    if not na(lbl_sl)
        label.delete(lbl_sl)

    line_tp2   := line.new(bar_index, active_tp2,   right, active_tp2,   color=clr_tp2,                 width=4)
    line_tp1   := line.new(bar_index, active_tp1,   right, active_tp1,   color=clr_tp1,                 width=3)
    line_entry := line.new(bar_index, active_entry, right, active_entry, color=color.white,              width=3)
    line_sl    := line.new(bar_index, active_sl,    right, active_sl,    color=color.new(color.red, 0),  width=3, style=line.style_dashed)

    lbl_tp2   := label.new(right, active_tp2,   "TP2    " + str.tostring(math.round(active_tp2,   2)), color=clr_tp2,                textcolor=active_is_bull ? color.black : color.white, style=label.style_label_left, size=size.normal)
    lbl_tp1   := label.new(right, active_tp1,   "TP1    " + str.tostring(math.round(active_tp1,   2)), color=clr_tp1,                textcolor=active_is_bull ? color.black : color.white, style=label.style_label_left, size=size.normal)
    lbl_entry := label.new(right, active_entry, "ENTRY  " + str.tostring(math.round(active_entry, 2)), color=color.white,            textcolor=color.black,                               style=label.style_label_left, size=size.normal)
    lbl_sl    := label.new(right, active_sl,    "SL     " + str.tostring(math.round(active_sl,    2)), color=color.new(color.red,0), textcolor=color.white,                               style=label.style_label_left, size=size.normal)

else
    if not na(line_tp2)
        line.delete(line_tp2)
        line_tp2 := na
    if not na(line_tp1)
        line.delete(line_tp1)
        line_tp1 := na
    if not na(line_entry)
        line.delete(line_entry)
        line_entry := na
    if not na(line_sl)
        line.delete(line_sl)
        line_sl := na
    if not na(lbl_tp2)
        label.delete(lbl_tp2)
        lbl_tp2 := na
    if not na(lbl_tp1)
        label.delete(lbl_tp1)
        lbl_tp1 := na
    if not na(lbl_entry)
        label.delete(lbl_entry)
        lbl_entry := na
    if not na(lbl_sl)
        label.delete(lbl_sl)
        lbl_sl := na

// ═══════════════════════════════════════════════
//  SIGNAL STATE FOR TABLES
// ═══════════════════════════════════════════════
var string last_sig_line1 = "NO ACTIVE TRADE"
var string last_sig_line2 = ""
var string last_sig_line3 = ""
var string last_sig_line4 = ""
var string last_sig_line5 = ""
var color  mon_bg         = color.new(color.gray, 20)
var color  mon_tc         = color.white

if bull_signal or bear_signal
    dir      = active_is_bull ? "LONG" : "SHORT"
    mon_bg  := active_is_bull ? color.new(color.lime, 0) : color.new(color.red, 0)
    mon_tc  := active_is_bull ? color.black : color.white
    last_sig_line1 := dir + "  |  " + active_kind + "  |  " + active_time
    last_sig_line2 := "Entry :  " + str.tostring(math.round(active_entry, 2))
    last_sig_line3 := "TP 1  :  " + str.tostring(math.round(active_tp1,  2))
    last_sig_line4 := "TP 2  :  " + str.tostring(math.round(active_tp2,  2))
    last_sig_line5 := "SL    :  " + str.tostring(math.round(active_sl,   2))

if not trade_active and not bull_signal and not bear_signal
    mon_bg         := color.new(color.gray, 20)
    mon_tc         := color.white
    last_sig_line1 := "NO ACTIVE TRADE"
    last_sig_line2 := ""
    last_sig_line3 := ""
    last_sig_line4 := ""
    last_sig_line5 := ""

sess_txt = in_london and in_ny ? "OVERLAP  |  Best Odds" : in_london ? "LONDON SESSION" : in_ny ? "NEW YORK SESSION" : "OUT OF SESSION"
pdh_txt  = "PDH: " + str.tostring(math.round(pd_high, 2)) + "   PDL: " + str.tostring(math.round(pd_low, 2))

// ═══════════════════════════════════════════════
//  TABLE 1 — SIGNAL MONITOR  (top right, large)
// ═══════════════════════════════════════════════
var table mon_tbl = table.new(position.top_right, 1, 8, border_width=2, border_color=color.new(color.white, 60))
if barstate.islast
    table.cell(mon_tbl, 0, 0, "  SIGNAL MONITOR  ",    text_color=color.white,  bgcolor=color.new(color.black, 0),  text_size=size.normal)
    table.cell(mon_tbl, 0, 1, sess_txt,                 text_color=color.yellow, bgcolor=color.new(color.black, 20), text_size=size.normal)
    table.cell(mon_tbl, 0, 2, pdh_txt,                  text_color=color.white,  bgcolor=color.new(color.black, 20), text_size=size.normal)
    table.cell(mon_tbl, 0, 3, "",                        text_color=mon_tc,       bgcolor=mon_bg,                    text_size=size.tiny)
    table.cell(mon_tbl, 0, 4, last_sig_line1,            text_color=mon_tc,       bgcolor=mon_bg,                    text_size=size.large)
    table.cell(mon_tbl, 0, 5, last_sig_line2,            text_color=mon_tc,       bgcolor=mon_bg,                    text_size=size.normal)
    table.cell(mon_tbl, 0, 6, last_sig_line3 + "   " + last_sig_line4, text_color=mon_tc, bgcolor=mon_bg,            text_size=size.normal)
    table.cell(mon_tbl, 0, 7, last_sig_line5,            text_color=mon_tc,       bgcolor=mon_bg,                    text_size=size.normal)

// ═══════════════════════════════════════════════
//  TABLE 2 — TIMEFRAME REMINDER  (bottom right, small)
// ═══════════════════════════════════════════════
var table tf_tbl = table.new(position.bottom_right, 1, 5, border_width=2, border_color=color.new(color.white, 60))
if barstate.islast
    table.cell(tf_tbl, 0, 0, "  TIMEFRAMES  ",          text_color=color.white,  bgcolor=color.new(color.navy, 0),   text_size=size.normal)
    table.cell(tf_tbl, 0, 1, "1H    Bias",               text_color=color.white,  bgcolor=color.new(color.navy, 20),  text_size=size.normal)
    table.cell(tf_tbl, 0, 2, "15M   Signal",             text_color=color.white,  bgcolor=color.new(color.navy, 20),  text_size=size.normal)
    table.cell(tf_tbl, 0, 3, "5M    Entry",              text_color=color.white,  bgcolor=color.new(color.navy, 20),  text_size=size.normal)
    table.cell(tf_tbl, 0, 4, "Overlap: 8AM-11AM EST",    text_color=color.yellow, bgcolor=color.new(color.navy, 20),  text_size=size.small)

// ═══════════════════════════════════════════════
//  SESSION BACKGROUND
// ═══════════════════════════════════════════════
bgcolor(in_london and not in_ny     ? color.new(color.blue,   92) : na, title="London Session")
bgcolor(in_ny     and not in_london ? color.new(color.green,  92) : na, title="NY Session")
bgcolor(in_london and in_ny         ? color.new(color.yellow, 88) : na, title="Overlap Session")

// ═══════════════════════════════════════════════
//  SIGNAL ARROWS
// ═══════════════════════════════════════════════
plotshape(bull_signal, title="Bull Signal", location=location.belowbar, style=shape.triangleup,   color=color.lime, size=size.small)
plotshape(bear_signal, title="Bear Signal", location=location.abovebar, style=shape.triangledown, color=color.red,  size=size.small)
