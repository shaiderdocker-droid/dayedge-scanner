<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DayEdge v3 ‚Äî Stock Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700&family=Barlow+Condensed:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#080c10; --panel:#0d1117; --panel2:#0a0f15;
  --border:#1a2332; --border2:#1e3a5f;
  --green:#00ff88; --gdim:#00c46a; --gglow:rgba(0,255,136,.12);
  --red:#ff4466; --yellow:#ffd166; --blue:#4fc3f7; --orange:#ff9b54; --purple:#c084fc;
  --t:#c9d1d9; --tdim:#586069; --tbright:#e6edf3;
  --mono:'Share Tech Mono',monospace; --sans:'Barlow',sans-serif; --disp:'Barlow Condensed',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--t);font-family:var(--sans);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.03) 2px,rgba(0,0,0,.03) 4px);pointer-events:none;z-index:1000}

header{background:var(--panel);border-bottom:1px solid var(--border2);padding:0 2rem;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:36px;height:36px;border:2px solid var(--green);display:flex;align-items:center;justify-content:center;box-shadow:0 0 12px var(--gglow)}
.logo-icon::before{content:'‚ñ≤';color:var(--green);font-size:14px}
.logo-text{font-family:var(--disp);font-size:1.6rem;font-weight:800;color:var(--tbright);letter-spacing:.05em}
.logo-text span{color:var(--green)}
.hdr-right{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.mkt-badge{font-family:var(--mono);font-size:.7rem;padding:.3rem .8rem;letter-spacing:.1em;text-transform:uppercase;border:1px solid}
.bullish{color:var(--green);border-color:var(--green);background:rgba(0,255,136,.08)}
.bearish{color:var(--red);border-color:var(--red);background:rgba(255,68,102,.08)}
.neutral{color:var(--yellow);border-color:var(--yellow);background:rgba(255,209,102,.08)}
.btn{background:transparent;font-family:var(--mono);font-size:.75rem;padding:.45rem 1rem;cursor:pointer;letter-spacing:.08em;text-transform:uppercase;transition:all .2s;border:1px solid;position:relative;overflow:hidden}
.btn-green{border-color:var(--green);color:var(--green)}
.btn-green:hover{background:var(--gglow);box-shadow:0 0 12px var(--gglow)}
.btn-blue{border-color:var(--blue);color:var(--blue)}
.btn-blue:hover{background:rgba(79,195,247,.08)}
.btn-purple{border-color:var(--purple);color:var(--purple)}
.btn-purple:hover{background:rgba(192,132,252,.08)}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn.loading::after{content:'';position:absolute;left:-100%;top:0;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);animation:shimmer 1.2s infinite}
@keyframes shimmer{to{left:100%}}

main{max-width:1600px;margin:0 auto;padding:2rem}

/* TAB SYSTEM */
.tabs{display:flex;gap:0;margin-bottom:2rem;border-bottom:1px solid var(--border)}
.tab{font-family:var(--mono);font-size:.72rem;padding:.6rem 1.5rem;cursor:pointer;letter-spacing:.1em;text-transform:uppercase;color:var(--tdim);border-bottom:2px solid transparent;transition:all .2s}
.tab.active{color:var(--green);border-bottom-color:var(--green)}
.tab:hover{color:var(--t)}
.tab-content{display:none}
.tab-content.active{display:block}

/* STATS */
.stats-bar{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:1.5rem}
.stat{background:var(--panel);border:1px solid var(--border);padding:1rem 1.25rem;position:relative;overflow:hidden}
.stat::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--green)}
.stat.red::before{background:var(--red)}
.stat.yellow::before{background:var(--yellow)}
.stat.blue::before{background:var(--blue)}
.stat.purple::before{background:var(--purple)}
.slabel{font-family:var(--mono);font-size:.62rem;color:var(--tdim);letter-spacing:.15em;text-transform:uppercase;margin-bottom:.3rem}
.sval{font-family:var(--disp);font-size:1.8rem;font-weight:800;color:var(--tbright);line-height:1}
.sval.g{color:var(--green)} .sval.r{color:var(--red)} .sval.y{color:var(--yellow)} .sval.b{color:var(--blue)} .sval.p{color:var(--purple)}
.ssub{font-family:var(--mono);font-size:.62rem;color:var(--tdim);margin-top:.25rem}

/* WIN RATE PANEL */
.wr-panel{background:var(--panel);border:1px solid var(--border);padding:1rem 1.5rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:2.5rem;flex-wrap:wrap}
.wr-item{display:flex;align-items:center;gap:.6rem}
.wr-label{font-family:var(--mono);font-size:.62rem;color:var(--tdim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:.2rem}
.wr-val{font-family:var(--disp);font-size:1.3rem;font-weight:800}
.wr-note{font-family:var(--mono);font-size:.65rem;color:var(--tdim);margin-left:auto}

/* SECTOR ROTATION */
.sector-bar{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.5rem}
.sector-pill{font-family:var(--mono);font-size:.65rem;padding:.3rem .7rem;border:1px solid;letter-spacing:.08em}
.hot{color:var(--green);border-color:rgba(0,255,136,.4);background:rgba(0,255,136,.06)}
.cold{color:var(--red);border-color:rgba(255,68,102,.4);background:rgba(255,68,102,.06)}
.sneutral{color:var(--tdim);border-color:var(--border)}

/* TABLE */
.table-wrap{background:var(--panel);border:1px solid var(--border);overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.85rem;min-width:1100px}
thead{background:var(--panel2);border-bottom:1px solid var(--border2)}
th{font-family:var(--mono);font-size:.6rem;color:var(--tdim);letter-spacing:.12em;text-transform:uppercase;padding:.8rem 1rem;text-align:left;font-weight:400;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .15s;cursor:pointer}
tbody tr:hover{background:rgba(0,255,136,.03)}
tbody tr.earn-warn{border-left:2px solid var(--red)}
tbody tr.weekly-down{opacity:.85}
td{padding:.85rem 1rem;vertical-align:middle}

.sym-cell{display:flex;align-items:center;gap:.6rem}
.sym{font-family:var(--disp);font-size:1.15rem;font-weight:800;color:var(--tbright)}
.earn-flag{font-family:var(--mono);font-size:.58rem;color:var(--red);border:1px solid var(--red);padding:.1rem .3rem}
.wt-up{font-size:.65rem;color:var(--green)} .wt-down{font-size:.65rem;color:var(--red)}

.grade{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;font-family:var(--mono);font-size:.72rem;font-weight:700;border:1px solid}
.grade-A{color:var(--green);border-color:var(--green);background:rgba(0,255,136,.08);box-shadow:0 0 6px rgba(0,255,136,.2)}
.grade-B{color:var(--yellow);border-color:var(--yellow);background:rgba(255,209,102,.08)}
.grade-C{color:var(--orange);border-color:var(--orange);background:rgba(255,155,84,.08)}

.score-wrap{display:flex;align-items:center;gap:.5rem}
.score-num{font-family:var(--mono);font-size:.95rem;color:var(--tbright);min-width:28px}
.sbar{height:3px;width:60px;background:var(--border);overflow:hidden}
.sfill{height:100%;background:linear-gradient(90deg,var(--gdim),var(--green))}

.num{font-family:var(--mono);font-size:.8rem}
.pos{color:var(--green)} .neg{color:var(--red)} .neut{color:var(--t)} .dim{color:var(--tdim)}

.badge{display:inline-block;font-family:var(--mono);font-size:.58rem;padding:.15rem .4rem;letter-spacing:.08em;text-transform:uppercase;border:1px solid}
.badge-yes{color:var(--blue);border-color:rgba(79,195,247,.4);background:rgba(79,195,247,.08)}
.badge-no{color:var(--tdim);border-color:var(--border)}
.badge-hot{color:var(--orange);border-color:rgba(255,155,84,.4);background:rgba(255,155,84,.08)}
.badge-warn{color:var(--red);border-color:rgba(255,68,102,.4);background:rgba(255,68,102,.08)}

.adx-bar{display:flex;align-items:center;gap:.4rem}
.adx-track{width:40px;height:3px;background:var(--border);overflow:hidden}
.adx-fill{height:100%;background:var(--blue)}

.reasons-row{display:none;background:var(--panel2)}
.reasons-row.open{display:table-row}
.reasons-td{padding:.6rem 1rem .8rem 3.5rem}
.reasons-list{display:flex;flex-wrap:wrap;gap:.35rem}
.rtag{font-family:var(--mono);font-size:.65rem;color:var(--tdim);background:var(--border);padding:.2rem .5rem;border-left:2px solid var(--border2)}

/* TRADE LEVELS PANEL (inside expand) */
.trade-panel{display:flex;gap:1.5rem;flex-wrap:wrap;margin-top:.75rem;padding:.75rem 1rem;background:rgba(0,255,136,.03);border:1px solid rgba(0,255,136,.1)}
.tl-item{text-align:center}
.tl-label{font-family:var(--mono);font-size:.58rem;color:var(--tdim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:.2rem}
.tl-val{font-family:var(--disp);font-size:1.1rem;font-weight:800}
.tl-entry{color:var(--blue)} .tl-stop{color:var(--red)} .tl-t1{color:var(--green)}
.tl-t2{color:var(--yellow)} .tl-t3{color:var(--orange)}

/* MORNING GOLIST */
.golist{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
.go-card{background:var(--panel);border:1px solid var(--border);padding:1.25rem;position:relative;overflow:hidden}
.go-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:linear-gradient(90deg,var(--green),var(--blue))}
.go-sym{font-family:var(--disp);font-size:1.5rem;font-weight:800;color:var(--tbright);margin-bottom:.5rem}
.go-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem .75rem;margin-bottom:.75rem}
.go-item label{font-family:var(--mono);font-size:.58rem;color:var(--tdim);letter-spacing:.1em;text-transform:uppercase;display:block}
.go-item span{font-family:var(--mono);font-size:.85rem}
.go-levels{background:var(--panel2);padding:.75rem;border:1px solid var(--border);margin-top:.5rem}
.go-levels-title{font-family:var(--mono);font-size:.58rem;color:var(--tdim);letter-spacing:.1em;text-transform:uppercase;margin-bottom:.5rem}
.go-lvl-row{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.72rem;margin-bottom:.2rem}

/* BACKTEST PANEL */
.bt-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
.bt-card{background:var(--panel);border:1px solid var(--border);padding:1.25rem}
.bt-title{font-family:var(--mono);font-size:.65rem;color:var(--tdim);letter-spacing:.12em;text-transform:uppercase;margin-bottom:.5rem}
.bt-val{font-family:var(--disp);font-size:2rem;font-weight:800}
.bt-sub{font-family:var(--mono);font-size:.65rem;color:var(--tdim);margin-top:.25rem}
.bt-grade-row{display:flex;gap:1.5rem;flex-wrap:wrap}
.bt-grade{background:var(--panel);border:1px solid var(--border);padding:1rem 1.5rem;flex:1;min-width:150px}

/* MISC */
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;padding-bottom:.6rem;border-bottom:1px solid var(--border)}
.section-title{font-family:var(--disp);font-size:1rem;font-weight:700;color:var(--tbright);letter-spacing:.1em;text-transform:uppercase}
.section-sub{font-family:var(--mono);font-size:.65rem;color:var(--tdim)}
.window-badge{font-family:var(--mono);font-size:.7rem;color:var(--purple);border:1px solid rgba(192,132,252,.4);background:rgba(192,132,252,.08);padding:.3rem .8rem;letter-spacing:.08em}

.empty{text-align:center;padding:3rem}
.empty-title{font-family:var(--disp);font-size:1.3rem;color:var(--tdim);letter-spacing:.1em}
.empty-sub{font-family:var(--mono);font-size:.75rem;color:var(--tdim);margin-top:.4rem}

.status-bar{margin-top:2rem;padding:.7rem 1.25rem;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sdot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-right:.5rem;box-shadow:0 0 6px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.smono{font-family:var(--mono);font-size:.68rem;color:var(--tdim)}

.toast{position:fixed;bottom:2rem;right:2rem;background:var(--panel);border:1px solid var(--green);color:var(--green);font-family:var(--mono);font-size:.78rem;padding:.7rem 1.2rem;box-shadow:0 0 20px var(--gglow);transform:translateY(80px);opacity:0;transition:all .3s;z-index:999}
.toast.show{transform:translateY(0);opacity:1}

.overlay{display:none;position:fixed;inset:0;background:rgba(8,12,16,.88);z-index:500;align-items:center;justify-content:center;flex-direction:column;gap:1.5rem}
.overlay.show{display:flex}
.overlay-text{font-family:var(--mono);font-size:.85rem;color:var(--green);letter-spacing:.1em}
.overlay-bar{width:200px;height:2px;background:var(--border);position:relative;overflow:hidden}
.overlay-bar::after{content:'';position:absolute;left:-50%;top:0;width:50%;height:100%;background:var(--green);animation:load 1.2s ease infinite}
@keyframes load{to{left:150%}}

@media(max-width:900px){.stats-bar{grid-template-columns:repeat(3,1fr)}.bt-grid{grid-template-columns:1fr}}
@media(max-width:600px){.stats-bar{grid-template-columns:repeat(2,1fr)}main{padding:1rem}.hdr-right{gap:.5rem}}
</style>
</head>
<body>

<div class="overlay" id="overlay">
  <div class="overlay-text" id="overlayText">SCANNING MARKETS...</div>
  <div class="overlay-bar"></div>
</div>
<div class="toast" id="toast"></div>

<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div class="logo-text">Day<span>Edge</span></div>
  </div>
  <div class="hdr-right">
    <div class="mkt-badge neutral" id="mktBadge">MARKET: ‚Äî</div>
    <div class="window-badge" id="windowBadge">‚è± ‚Äî</div>
    <button class="btn btn-blue" onclick="runMorning()">‚òÄ MORNING SCAN</button>
    <button class="btn btn-purple" onclick="runBacktest()">üìä BACKTEST</button>
    <button class="btn btn-green" id="scanBtn" onclick="runScan()">‚ñ∂ EVENING SCAN</button>
  </div>
</header>

<main>
  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat"><div class="slabel">Scanned</div><div class="sval" id="sScanned">‚Äî</div></div>
    <div class="stat"><div class="slabel">Setups</div><div class="sval g" id="sFound">‚Äî</div></div>
    <div class="stat"><div class="slabel">Grade A</div><div class="sval g" id="sGradeA">‚Äî</div></div>
    <div class="stat blue"><div class="slabel">Win Rate</div><div class="sval b" id="sWR">‚Äî</div><div class="ssub" id="sWRSub">Collecting data...</div></div>
    <div class="stat yellow"><div class="slabel">Last Scan</div><div class="sval y" id="sTime" style="font-size:1rem;padding-top:.3rem">‚Äî</div></div>
  </div>

  <!-- Win Rate by Grade -->
  <div class="wr-panel" id="wrPanel" style="display:none">
    <div><div class="wr-label">Win Rate by Grade</div></div>
    <div class="wr-item"><div class="grade grade-A">A</div><div><div class="wr-label">Grade A</div><div class="wr-val" id="wrA" style="color:var(--green)">‚Äî</div></div></div>
    <div class="wr-item"><div class="grade grade-B">B</div><div><div class="wr-label">Grade B</div><div class="wr-val" id="wrB" style="color:var(--yellow)">‚Äî</div></div></div>
    <div class="wr-item"><div class="grade grade-C">C</div><div><div class="wr-label">Grade C</div><div class="wr-val" id="wrC" style="color:var(--orange)">‚Äî</div></div></div>
    <div class="wr-note">Win = stock up &gt;1% next day ¬∑ Tracked automatically each evening</div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('evening',this)">TONIGHT'S WATCHLIST</div>
    <div class="tab" onclick="switchTab('morning',this)">MORNING GO-LIST</div>
    <div class="tab" onclick="switchTab('sectors',this)">SECTOR ROTATION</div>
    <div class="tab" onclick="switchTab('backtest',this)">BACKTEST</div>
  </div>

  <!-- EVENING TAB -->
  <div class="tab-content active" id="tab-evening">
    <div class="section-hdr">
      <div class="section-title">Tonight's Setups</div>
      <div class="section-sub" id="mktDate">‚Äî</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Symbol</th><th>Score</th><th>Price</th><th>Gap%</th><th>PreMkt</th>
            <th>RVOL</th><th>ATR%</th><th>ADX</th><th>$Vol(M)</th>
            <th>Float</th><th>R/R</th><th>RS</th><th>Options</th><th>Catalyst</th><th>Tech</th>
          </tr>
        </thead>
        <tbody id="mainTable">
          <tr><td colspan="15"><div class="empty"><div class="empty-title">NO SCAN DATA</div><div class="empty-sub">Click Evening Scan to start</div></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MORNING TAB -->
  <div class="tab-content" id="tab-morning">
    <div class="section-hdr">
      <div class="section-title">Morning Go-List</div>
      <div class="section-sub" id="morningTime">Stocks confirming pre-market strength from last night's picks</div>
    </div>
    <div class="golist" id="goList">
      <div class="empty"><div class="empty-title">NO MORNING DATA</div><div class="empty-sub">Click Morning Scan or wait for 9am ET auto-run</div></div>
    </div>
  </div>

  <!-- SECTORS TAB -->
  <div class="tab-content" id="tab-sectors">
    <div class="section-hdr">
      <div class="section-title">Sector Rotation</div>
      <div class="section-sub">5-day and 20-day performance by sector ETF</div>
    </div>
    <div id="sectorContent">
      <div class="empty"><div class="empty-title">RUN EVENING SCAN</div><div class="empty-sub">Sector data loads with the evening scan</div></div>
    </div>
  </div>

  <!-- BACKTEST TAB -->
  <div class="tab-content" id="tab-backtest">
    <div class="section-hdr">
      <div class="section-title">Backtest Results</div>
      <div class="section-sub">Historical simulation of scanner signals</div>
    </div>
    <div id="backtestContent">
      <div class="empty"><div class="empty-title">NO BACKTEST RUN</div><div class="empty-sub">Click the Backtest button to run (takes 5-10 min)</div></div>
    </div>
  </div>

  <div class="status-bar">
    <div class="smono"><span class="sdot"></span>DAYEDGE v3 ¬∑ EVENING SCAN 6PM ET ¬∑ MORNING SCAN 9AM ET ¬∑ CLICK ROW FOR TRADE LEVELS</div>
    <div class="smono" id="clock">‚Äî</div>
  </div>
</main>

<script>
setInterval(()=>document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false})+' LOCAL',1000);

function switchTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

function toast(msg,err=false){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.borderColor=err?'var(--red)':'var(--green)'; t.style.color=err?'var(--red)':'var(--green)';
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3500);
}

function setOverlay(show,msg='SCANNING...'){
  document.getElementById('overlay').classList.toggle('show',show);
  document.getElementById('overlayText').textContent=msg;
}

function rs(v){
  if(v>=2) return {t:'++',c:'pos'}; if(v===1) return {t:'+',c:'pos'};
  if(v<=-2) return {t:'--',c:'neg'}; if(v===-1) return {t:'-',c:'neg'};
  return {t:'~',c:'dim'};
}

function renderMain(data){
  if(!data) return;
  const cond=data.market_condition||'neutral';
  const b=document.getElementById('mktBadge');
  b.textContent='MARKET: '+cond.toUpperCase(); b.className='mkt-badge '+cond;
  if(data.best_trading_window) document.getElementById('windowBadge').textContent='‚è± '+data.best_trading_window;
  document.getElementById('sScanned').textContent=data.total_scanned||'‚Äî';
  document.getElementById('sFound').textContent=(data.results||[]).length;
  document.getElementById('sGradeA').textContent=(data.results||[]).filter(r=>r.grade==='A').length;
  if(data.timestamp) document.getElementById('sTime').textContent=new Date(data.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  if(data.market_date) document.getElementById('mktDate').textContent='FOR: '+data.market_date.toUpperCase();

  if(data.win_rate){
    const w=data.win_rate;
    document.getElementById('sWR').textContent=w.overall_win_rate+'%';
    document.getElementById('sWRSub').textContent=w.total_wins+'W / '+(w.total_picks-w.total_wins)+'L';
    document.getElementById('wrPanel').style.display='flex';
    if(w.by_grade){
      document.getElementById('wrA').textContent=w.by_grade.A?w.by_grade.A.win_rate+'%':'N/A';
      document.getElementById('wrB').textContent=w.by_grade.B?w.by_grade.B.win_rate+'%':'N/A';
      document.getElementById('wrC').textContent=w.by_grade.C?w.by_grade.C.win_rate+'%':'N/A';
    }
  }

  if(data.sector_rotation) renderSectors(data.sector_rotation);

  const tbody=document.getElementById('mainTable');
  if(!data.results||!data.results.length){
    tbody.innerHTML=`<tr><td colspan="15"><div class="empty"><div class="empty-title">${data.error||'NO SETUPS FOUND'}</div><div class="empty-sub">Try running the scan again</div></div></td></tr>`;
    return;
  }
  tbody.innerHTML='';
  data.results.forEach(s=>{
    const gapC=s.gap_pct>0?'pos':s.gap_pct<0?'neg':'neut';
    const pmC=s.pm_change>0?'pos':s.pm_change<0?'neg':'dim';
    const sp=Math.min((s.score/10)*100,100);
    const rsv=rs(s.rs_score);
    const adxPct=Math.min((s.adx/50)*100,100);
    const techDots=[...Array(3)].map((_,i)=>`<span style="color:${i<s.tech_score?'var(--green)':'var(--border2)'}">\u25cf</span>`).join('');
    const wtIcon=s.weekly_trend===1?'<span class="wt-up">‚ñ≤</span>':s.weekly_trend===-1?'<span class="wt-down">‚ñº</span>':'';
    const rrC=s.rr_ratio?(s.rr_ratio>=2?'pos':s.rr_ratio<1?'neg':'neut'):'dim';

    const row=document.createElement('tr');
    if(s.earnings_risky) row.classList.add('earn-warn');
    row.innerHTML=`
      <td><div class="sym-cell"><span class="grade grade-${s.grade}">${s.grade}</span><div>
        <div class="sym">${s.symbol} ${wtIcon}</div>
        ${s.earnings_risky?`<span class="earn-flag">EARN ${s.days_to_earnings}D</span>`:''}
      </div></div></td>
      <td><div class="score-wrap"><span class="score-num">${s.score}</span><div class="sbar"><div class="sfill" style="width:${sp}%"></div></div></div></td>
      <td><span class="num">$${s.last_close.toFixed(2)}</span></td>
      <td><span class="num ${gapC}">${s.gap_pct>0?'+':''}${s.gap_pct}%</span></td>
      <td><span class="num ${pmC}">${s.pm_change>0?'+':''}${s.pm_change}%</span></td>
      <td><span class="num ${s.rvol>=2?'pos':'neut'}">${s.rvol}x</span></td>
      <td><span class="num ${s.atr_pct>=2?'pos':'neut'}">${s.atr_pct}%</span></td>
      <td><div class="adx-bar"><div class="adx-track"><div class="adx-fill" style="width:${adxPct}%"></div></div><span class="num dim">${s.adx}</span></div></td>
      <td><span class="num ${s.dollar_vol_m>=50?'pos':'neut'}">$${s.dollar_vol_m}M</span></td>
      <td><span class="num dim">${s.float_m?s.float_m+'M':'‚Äî'}</span></td>
      <td><span class="num ${rrC}">${s.rr_ratio?s.rr_ratio+':1':'‚Äî'}</span></td>
      <td><span class="num ${rsv.c}">${rsv.t}</span></td>
      <td><span class="badge ${s.unusual_options?'badge-hot':'badge-no'}">${s.unusual_options?'YES':'‚Äî'}</span></td>
      <td><span class="badge ${s.has_catalyst?'badge-yes':'badge-no'}">${s.has_catalyst?'YES':'‚Äî'}</span></td>
      <td>${techDots}</td>
    `;

    const tl=s.trade_levels;
    const rrow=document.createElement('tr');
    rrow.className='reasons-row';
    rrow.innerHTML=`<td colspan="15"><div class="reasons-td">
      <div class="reasons-list">${(s.reasons||[]).map(r=>`<span class="rtag">${r}</span>`).join('')}
        ${s.sector_etf?`<span class="rtag">üìä Sector: ${s.sector_etf}</span>`:''}
        ${s.gap_fill_prob!==null&&s.gap_fill_prob!==undefined?`<span class="rtag">üìà Gap fill rate: ${Math.round(s.gap_fill_prob*100)}%</span>`:''}
        ${s.ml_adjustment?`<span class="rtag">ü§ñ ML adjustment: ${s.ml_adjustment>0?'+':''}${s.ml_adjustment}</span>`:''}
      </div>
      ${tl?`<div class="trade-panel">
        <div class="tl-item"><div class="tl-label">Entry</div><div class="tl-val tl-entry">$${tl.entry}</div></div>
        <div class="tl-item"><div class="tl-label">Stop Loss</div><div class="tl-val tl-stop">$${tl.stop} <span style="font-size:.7rem;color:var(--tdim)">(${tl.stop_pct}%)</span></div></div>
        <div class="tl-item"><div class="tl-label">Target 1 (1:1)</div><div class="tl-val tl-t1">$${tl.target1}</div></div>
        <div class="tl-item"><div class="tl-label">Target 2 (2:1)</div><div class="tl-val tl-t2">$${tl.target2}</div></div>
        <div class="tl-item"><div class="tl-label">Target 3 (3:1)</div><div class="tl-val tl-t3">$${tl.target3}</div></div>
        <div class="tl-item"><div class="tl-label">ATR</div><div class="tl-val" style="color:var(--tdim)">$${tl.atr}</div></div>
        <div class="tl-item"><div class="tl-label">Resistance</div><div class="tl-val" style="color:var(--tdim)">$${tl.resistance}</div></div>
      </div>`:''}
    </div></td>`;

    row.addEventListener('click',()=>rrow.classList.toggle('open'));
    tbody.appendChild(row); tbody.appendChild(rrow);
  });
}

function renderMorning(data){
  if(!data) return;
  if(data.timestamp) document.getElementById('morningTime').textContent='Updated: '+new Date(data.timestamp).toLocaleTimeString();
  const el=document.getElementById('goList');
  if(!data.golist||!data.golist.length){
    el.innerHTML=`<div class="empty"><div class="empty-title">NO CONFIRMATIONS</div><div class="empty-sub">${data.message||'No stocks confirming pre-market strength'}</div></div>`;
    return;
  }
  el.innerHTML=data.golist.map(s=>{
    const tl=s.trade_levels;
    return `<div class="go-card">
      <div class="go-sym">${s.symbol} <span class="grade grade-${s.grade}" style="vertical-align:middle">${s.grade}</span></div>
      <div class="go-grid">
        <div class="go-item"><label>Pre-Market</label><span style="color:${s.pm_change>0?'var(--green)':'var(--red)'}">${s.pm_change>0?'+':''}${s.pm_change}%</span></div>
        <div class="go-item"><label>Evening Score</label><span style="color:var(--blue)">${s.evening_score}/10</span></div>
        <div class="go-item"><label>Prev Close</label><span>$${s.prev_close}</span></div>
        <div class="go-item"><label>Best Window</label><span style="color:var(--purple);font-size:.7rem">${s.best_window}</span></div>
      </div>
      ${tl?`<div class="go-levels">
        <div class="go-levels-title">Trade Levels</div>
        <div class="go-lvl-row"><span style="color:var(--tdim)">Entry</span><span style="color:var(--blue)">$${tl.entry}</span></div>
        <div class="go-lvl-row"><span style="color:var(--tdim)">Stop</span><span style="color:var(--red)">$${tl.stop} (${tl.stop_pct}%)</span></div>
        <div class="go-lvl-row"><span style="color:var(--tdim)">T1</span><span style="color:var(--green)">$${tl.target1}</span></div>
        <div class="go-lvl-row"><span style="color:var(--tdim)">T2</span><span style="color:var(--yellow)">$${tl.target2}</span></div>
        <div class="go-lvl-row"><span style="color:var(--tdim)">T3</span><span style="color:var(--orange)">$${tl.target3}</span></div>
      </div>`:''}
    </div>`;
  }).join('');
}

function renderSectors(data){
  if(!data||!Object.keys(data).length) return;
  const el=document.getElementById('sectorContent');
  const sorted=Object.entries(data).sort((a,b)=>b[1].perf_5d-a[1].perf_5d);
  el.innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem">
      ${sorted.map(([etf,d])=>`
        <div style="background:var(--panel);border:1px solid var(--border);padding:1rem">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
            <span style="font-family:var(--disp);font-size:1.2rem;font-weight:800;color:var(--tbright)">${etf}</span>
            <span class="sector-pill ${d.momentum}">${d.momentum.toUpperCase()}</span>
          </div>
          <div style="display:flex;gap:1rem">
            <div><div class="slabel">5D</div><div class="num ${d.perf_5d>0?'pos':d.perf_5d<0?'neg':'neut'}">${d.perf_5d>0?'+':''}${d.perf_5d}%</div></div>
            <div><div class="slabel">20D</div><div class="num ${d.perf_20d>0?'pos':d.perf_20d<0?'neg':'neut'}">${d.perf_20d>0?'+':''}${d.perf_20d}%</div></div>
          </div>
        </div>
      `).join('')}
    </div>`;
}

function renderBacktest(data){
  if(!data) return;
  const el=document.getElementById('backtestContent');
  el.innerHTML=`
    <div class="bt-grid">
      <div class="bt-card"><div class="bt-title">Win Rate</div><div class="bt-val" style="color:${data.win_rate>55?'var(--green)':data.win_rate>45?'var(--yellow)':'var(--red)'}">${data.win_rate}%</div><div class="bt-sub">${data.total_signals} total signals</div></div>
      <div class="bt-card"><div class="bt-title">Avg Win</div><div class="bt-val" style="color:var(--green)">+${data.avg_gain}%</div><div class="bt-sub">Average winning trade</div></div>
      <div class="bt-card"><div class="bt-title">Avg Loss</div><div class="bt-val" style="color:var(--red)">${data.avg_loss}%</div><div class="bt-sub">Average losing trade</div></div>
    </div>
    <div class="section-hdr"><div class="section-title">Win Rate by Grade</div></div>
    <div class="bt-grade-row">
      ${['A','B','C'].map(g=>{
        const d=data.by_grade[g];
        const color=g==='A'?'var(--green)':g==='B'?'var(--yellow)':'var(--orange)';
        return `<div class="bt-grade">
          <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem">
            <span class="grade grade-${g}">${g}</span>
            <span class="slabel">Grade ${g}</span>
          </div>
          <div class="bt-val" style="color:${color}">${d.win_rate}%</div>
          <div class="bt-sub">${d.wins}W / ${d.total-d.wins}L (${d.total} signals)</div>
        </div>`;
      }).join('')}
    </div>
    <div style="margin-top:1rem;font-family:var(--mono);font-size:.65rem;color:var(--tdim)">
      Run date: ${new Date(data.run_date).toLocaleString()} ¬∑ Lookback: ${data.lookback_days||60} days
    </div>`;
}

async function loadAll(){
  try{const r=await fetch('/api/scan'); const d=await r.json(); renderMain(d);}catch(e){}
  try{const r=await fetch('/api/morning'); const d=await r.json(); renderMorning(d);}catch(e){}
  try{const r=await fetch('/api/backtest'); const d=await r.json(); if(!d.error) renderBacktest(d);}catch(e){}
}

async function runScan(){
  const btn=document.getElementById('scanBtn'); btn.disabled=true; btn.classList.add('loading');
  const msgs=['CHECKING SPY...','SECTOR ROTATION...','FETCHING DATA...','ADX & WEEKLY TRENDS...','OPTIONS ACTIVITY...','ML SCORING...','RANKING...'];
  let i=0; setOverlay(true,msgs[0]);
  const iv=setInterval(()=>document.getElementById('overlayText').textContent=msgs[Math.min(++i,msgs.length-1)],4000);
  try{
    const r=await fetch('/api/run-scan',{method:'POST'}); const d=await r.json();
    clearInterval(iv); setOverlay(false);
    if(d.status==='success'){await loadAll(); toast('‚úì EVENING SCAN COMPLETE');}
    else toast('ERROR: '+d.message,true);
  }catch(e){clearInterval(iv);setOverlay(false);toast('CONNECTION ERROR',true);}
  btn.disabled=false; btn.classList.remove('loading');
}

async function runMorning(){
  setOverlay(true,'RUNNING MORNING CONFIRMATION...');
  try{
    const r=await fetch('/api/run-morning',{method:'POST'}); const d=await r.json();
    setOverlay(false);
    if(d.status==='success'){
      const mr=await fetch('/api/morning'); renderMorning(await mr.json());
      switchTab('morning',document.querySelectorAll('.tab')[1]);
      toast('‚úì MORNING SCAN COMPLETE');
    }else toast('ERROR: '+d.message,true);
  }catch(e){setOverlay(false);toast('ERROR',true);}
}

async function runBacktest(){
  setOverlay(true,'RUNNING BACKTEST ‚Äî THIS TAKES 5-10 MINUTES...');
  try{
    const r=await fetch('/api/run-backtest',{method:'POST'}); const d=await r.json();
    setOverlay(false);
    if(d.status==='success'){
      renderBacktest(d.data);
      switchTab('backtest',document.querySelectorAll('.tab')[3]);
      toast('‚úì BACKTEST COMPLETE');
    }else toast('ERROR: '+d.message,true);
  }catch(e){setOverlay(false);toast('ERROR',true);}
}

loadAll();
setInterval(loadAll,60000);
</script>
</body>
</html>
